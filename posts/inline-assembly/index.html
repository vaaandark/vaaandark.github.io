<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>内联汇编 | vaaandark&#39;s blog</title>
<meta name="keywords" content="汇编语言, C语言, 编程语言, GCC">
<meta name="description" content="高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。
分类
在 GNU 的 GCC 中，内联汇编被分为两类：Basic asm 和 Extended asm 。">
<meta name="author" content="vaaandark">
<link rel="canonical" href="https://vaaandark.top/posts/inline-assembly/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.556a50c7c92c2556e588f602528ac3c41884cdb6e537ce0647b5e200cd1c2094.css" integrity="sha256-VWpQx8ksJVbliPYCUorDxBiEzbblN84GR7XiAM0cIJQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://vaaandark.top/image/vaaandark.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://vaaandark.top/image/vaaandark.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://vaaandark.top/image/vaaandark.png">
<link rel="apple-touch-icon" href="https://vaaandark.top/image/vaaandark.png">
<link rel="mask-icon" href="https://vaaandark.top/image/vaaandark.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://vaaandark.top/posts/inline-assembly/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://vaaandark.top/posts/inline-assembly/">
  <meta property="og:site_name" content="vaaandark&#39;s blog">
  <meta property="og:title" content="内联汇编">
  <meta property="og:description" content="高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。
分类 在 GNU 的 GCC 中，内联汇编被分为两类：Basic asm 和 Extended asm 。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-01-02T16:27:19+08:00">
    <meta property="article:modified_time" content="2023-01-02T16:27:19+08:00">
    <meta property="article:tag" content="汇编语言">
    <meta property="article:tag" content="C语言">
    <meta property="article:tag" content="编程语言">
    <meta property="article:tag" content="GCC">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="内联汇编">
<meta name="twitter:description" content="高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。
分类
在 GNU 的 GCC 中，内联汇编被分为两类：Basic asm 和 Extended asm 。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://vaaandark.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "内联汇编",
      "item": "https://vaaandark.top/posts/inline-assembly/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "内联汇编",
  "name": "内联汇编",
  "description": "高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。\n分类 在 GNU 的 GCC 中，内联汇编被分为两类：Basic asm 和 Extended asm 。\n",
  "keywords": [
    "汇编语言", "C语言", "编程语言", "GCC"
  ],
  "articleBody": "高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。\n分类 在 GNU 的 GCC 中，内联汇编被分为两类：Basic asm 和 Extended asm 。\nGCC 的官方文档中写到，在函数中混合使用 C 语言和汇编语言时，最好使用扩展形式；但是要在顶层(top level)包含汇编语言，则必须使用基本形式。\n这里的 top level 一词非常诡异，让我摸不着头脑，之后我在官方文档的后文发现了蛛丝马迹：\n两种必须使用 Basic asm 的情形：\nExtended asm 声明必须在 C 函数内，所以如果在文件作用域(top-level)，在函数之外使用汇编，必须使用 Basic asm 。你可以使用此技术发出汇编程序指令，定义可在文件的其他位置调用的汇编语言宏，或用汇编语言编写整个函数。 函数的属性(attribute)被声明为 naked 时必须使用 Basic asm 。 naked attribute 在此不做展开。\n谜底揭开了，原来 top level 指的就是文件这一层。\nBasic asm 可以使用关键字 asm 来声明一段内联汇编，不过这是 GNU 的拓展，如果在编译条件中使用了 -std 或者 -ansi 时，必须使用 __asm__ 。\n修饰 可以使用 volatile 和 inline 来修饰，不过 volatile 没有作用，所有的内联汇编代码段都是默认 volatile 的。如果使用 inline ，那么为了内联的目的，内联汇编语句的大小被当作是可能的最小大小。\n这里涉及到了内联汇编的大小估计，这是因为内联汇编生成的最终代码只由汇编器(Assembler)知晓，所以编译器需要自己估算，通过查找 '\\n\\t', ';' 等符号来估计指令数（行数），再乘以可能的最长指令长度来获得估算大小。所以如果在 inline 的 Basic asm 中使用了伪指令等能生成汇编语句的成分，汇编器可能会报错 unreachable 。\n是否需要估计内联汇编的大小，这个与平台有关。\n参数 又被称为 AssemblerTemplate ，由字符串字面值组成，该字符串由汇编语句组成，可以包括伪指令，GCC 的编译器并不检查它们的有效性，指令会被直接传递到汇编器中。\n在一段内联汇编中使用多条汇编语句时要注意自己使用的是什么汇编器（以及它们使用的是何种汇编方言），一般都可以用 '\\n\\t' 来分隔，有些汇编器可以使用 ';' ，但要注意在这种汇编方言中分号是不是注释开始的符号。\n注意 由于调用函数以及访问 C 数据可能很复杂，在这种情况下使用 Extended asm 是更好的选择。\n在编译器优化后连续的 asm 声明可能不再连续，所以如要需要连续语句，请写在同一个 asm 语句中。尤其是两个 asm 声明中包含了跳转时，如果被编译器调整顺序则会产生意想不到的后果。如果要跳转到 C 标签，还是使用 Extended asm 更好。\n如果在汇编语句中定义了符号或者标签，可能会导致重复符号的错误。\nExtended asm 拓展内联汇编有两种模板：\nasm asm-qualifiers ( AssemblerTemplate : OutputOperands [ : InputOperands [ : Clobbers ] ]) asm asm-qualifiers ( AssemblerTemplate : OutputOperands : InputOperands : Clobbers : GotoLabels) 同样地，在不使用 GNU 拓展时要用 __asm__ 代替 asm。\n修饰 除了 volatile 和 inline 外，还有 goto ，表示这段内联汇编代码可能会跳转到 GotoLabels 中的某一个标签上。\n参数 input, output, goto 的操作数加起来不能超过 30 个。\nAssemblerTemplate 同样是由字符串字面值组成，但是里面包含了一些标识符，它们指向了 output, input, goto 中的操作数。\nOutputOperands 不能将其单纯理解为输出，而是理解为会被修改的变量。\n由 AssemblerTemplate 中的指令修改的 C 变量列表，由逗号分隔，可以为空。\n结构一般为：\n[ [asmSymbolicName] ] constraint (cvariablename) asmSymbolicName 可以理解为在这段拓展内联汇编中的符号别名，它可以和上下文中的 C 语言符号重复，也可以和其他内联汇编代码中的符号名重复。在 AssemblerTemplate 中的使用方法为 %[Value]。\n如果不使用符号别名，则必须使用位置编号来指示符号，例如 OutputOperands 中有三项，则用 %0, %1 和 %2 表示。\nconstraint Output 的约束修饰符必须是以 '=' 开始（表示将会覆写这个变量），如果这个变量既被读也被写就需要 '+' 。当使用 '=' 时不要假定可以读取到将被覆写的变量的当前值，除非这个变量也在 Input 列表中。\n使用了 '+' 的操作数视作两个（在计算总个数及位置时）。\n还需要对值所在的位置进行约束，例如 'r' 表示寄存器，'m' 表示在内存。如果使用了一个以上的位置约束修饰符，编译器会选择它认为最好的方式进行优化。\n也可以使用数字进行约束，例如：\nasm (\"incl %0\" :\"=a\"(var):\"0\"(var)); 表示输入中的 var 使用的是和输出中的 var 相同的约束，这里的 0 表示为编号为 0 的操作数。\n常用的约束：\n符号 含义 I a constant a use eax b use ebx c use ecx d use edx S use esi D use edi r use one of eax, ebx, ecx or edx q use one of eax, ebx, ecx, edx, esi or edi 其余见 GCC 文档。\ncvariablename 一个 C 左值表达式，一般为变量。\nInputOperands 不能将其单纯理解为输入，而是理解为会被读取的变量。\n由 AssemblerTemplate 中的指令读取的 C 表达式列表，由逗号分隔，可以为空。\n结构也为：\n[ [asmSymbolicName] ] constraint (cvariablename) asmSymbolicName 如果有两个输入操作数，三个输出操作数，则第一个输入操作数为 %2 ，第二个为 %3 ，第三个为 %4 。\n一个例子：\nasm (\"cmoveq %1, %2, %[result]\" : [result] \"=r\"(result) : \"r\" (test), \"r\" (new), \"[result]\" (old)); Clobbers In software engineering and computer science, clobbering a file, processor register or a region of computer memory is the process of overwriting its contents completely, whether intentionally or unintentionally, or to indicate that such an action will likely occur.\n以逗号分隔的寄存器列表，一般为 AssemblerTemplate 更改的其他值（没有被列入 OutputOperands 的部分）。例如一些汇编指令（例如 cld ）有副作用，会使用到额外的寄存器。\n有两个特殊的 clobber ：\ncc - 表示将会修改 flag 寄存器。\nmemory - 这个 clobber 可以告诉编译器，这段内联汇编代码将对输入和输出操作数之外的项执行内存读取或写入操作（例如，输入操作数是一个指针，需要访问它指向的内存）。\n使用 memory 时，为了确保内存中包含正确的值，GCC 可能需要在执行这段内联汇编之前，将特定的寄存器值刷新到内存中。\n此外，在执行一个提前读取操作之前，编译器不会假定从内存中读取的值在执行该提前读取操作之后保持不变，而是会根据需要重新加载这些值。\nmemory 这个 clobber 有效地为编译器形成了读/写内存障碍。但这并不能阻止处理器在内联汇编语句之后执行推测性读操作。这种情况下还是需要 fence 指令。\nGotoLabels 此部分包含 C 标签的列表，当使用 goto 形式时，AssemblerTemplate 中的代码可以跳转到这些标签。\n要引用汇编程序模板中的标签，需要在它前面加上 'l' ，后面加上它在 GotoLabels 中的位置与输入和输出操作数的数目之和。带约束修饰符 '+' 的输出操作数被视为两个操作数。例如，如果有三个输入操作数，一个输出操作数带有约束修饰符 '+'，一个输出操作数带有约束修饰符 '=' ，那么 GotoLabels 的第一个标签称为 %l6 ，第二个称为 %l7 。\n也可以使用实际的 C 标签名，例如如果要引用 GotoLabels 中的 carry 标签，可以使用 %l[carry] ，这也是推荐的方法，避免了对编号的计算。\n实例 两数之和：\nint main(void) { int foo = 10, bar = 15; __asm__ __volatile__(\"addl %%ebx,%%eax\" :\"=a\"(foo) :\"a\"(foo), \"b\"(bar) ); printf(\"foo+bar=%d\\n\", foo); return 0; } 或者：\n__asm__ __volatile__( \" lock ;\\n\" \" addl %1,%0 ;\\n\" : \"=m\" (my_var) : \"ir\" (my_int), \"m\" (my_var) : /* no clobber-list */ ); lock 表示这是个原子操作。\n字符串复制：\nstatic inline char * strcpy(char * dest,const char *src) { int d0, d1, d2; __asm__ __volatile__( \"1:\\tlodsb\\n\\t\" \"stosb\\n\\t\" \"testb %%al,%%al\\n\\t\" \"jne 1b\" : \"=\u0026S\" (d0), \"=\u0026D\" (d1), \"=\u0026a\" (d2) : \"0\" (src),\"1\" (dest) : \"memory\"); return dest; } #define mov_blk(src, dest, numwords) \\ __asm__ __volatile__ ( \\ \"cld\\n\\t\" \\ \"rep\\n\\t\" \\ \"movsl\" \\ : \\ : \"S\" (src), \"D\" (dest), \"c\" (numwords) \\ : \"%ecx\", \"%esi\", \"%edi\" \\ ) Linux 系统调用：\n#define _syscall3(type,name,type1,arg1,type2,arg2,type3,arg3) \\ type name(type1 arg1,type2 arg2,type3 arg3) \\ { \\ long __res; \\ __asm__ volatile ( \"int $0x80\" \\ : \"=a\" (__res) \\ : \"0\" (__NR_##name),\"b\" ((long)(arg1)),\"c\" ((long)(arg2)), \\ \"d\" ((long)(arg3))); \\ __syscall_return(type,__res); \\ } Linux 退出：\n{ asm(\"movl $1,%%eax; /* SYS_exit is 1 */ xorl %%ebx,%%ebx; /* Argument is in ebx, it is 0 */ int $0x80\" /* Enter kernel mode */ ); } 参考资料 内联汇编深入起来非常繁杂，有些功能需要使用的时候可以直接查看 GNU 的文档。\nGCC Inline Assembly HOWTO\nGCC doc in web archive\nHow to Use Inline Assembly Language in C Code\nBasic Asm\nExtended Asm\nHow to Use Inline Assembly Language in C Code\nDeclaring Attributes of Functions\nLocal Register Variables\n",
  "wordCount" : "2692",
  "inLanguage": "zh",
  "datePublished": "2023-01-02T16:27:19+08:00",
  "dateModified": "2023-01-02T16:27:19+08:00",
  "author":{
    "@type": "Person",
    "name": "vaaandark"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vaaandark.top/posts/inline-assembly/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "vaaandark's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vaaandark.top/image/vaaandark.png"
    }
  }
}
</script>


</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://vaaandark.top/" accesskey="h" title="vaaandark&#39;s blog (Alt + H)">
                <img src="https://vaaandark.top/image/vaaandark.png" alt="" aria-label="logo"
                    height="35">vaaandark&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://vaaandark.top/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/posts/" title="Posts">
                    <span>📄 归档</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/categories/" title="categories">
                    <span>📂 分类</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/tags/" title="tags">
                    <span>🔖 标签</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/about/" title="关于我">
                    <span>🙋 关于</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/links/" title="友链">
                    <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://vaaandark.top/">主页</a>&nbsp;»&nbsp;<a href="https://vaaandark.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      内联汇编
    </h1>
    <div class="post-meta"><span title='2023-01-02 16:27:19 +0800 CST'>2023 1月 02</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;vaaandark

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%88%86%e7%b1%bb" aria-label="分类">分类</a></li>
                <li>
                    <a href="#basic-asm" aria-label="Basic asm">Basic asm</a><ul>
                        
                <li>
                    <a href="#%e4%bf%ae%e9%a5%b0" aria-label="修饰">修饰</a></li>
                <li>
                    <a href="#%e5%8f%82%e6%95%b0" aria-label="参数">参数</a></li>
                <li>
                    <a href="#%e6%b3%a8%e6%84%8f" aria-label="注意">注意</a></li></ul>
                </li>
                <li>
                    <a href="#extended-asm" aria-label="Extended asm">Extended asm</a><ul>
                        
                <li>
                    <a href="#%e4%bf%ae%e9%a5%b0-1" aria-label="修饰">修饰</a></li>
                <li>
                    <a href="#%e5%8f%82%e6%95%b0-1" aria-label="参数">参数</a><ul>
                        
                <li>
                    <a href="#assemblertemplate" aria-label="AssemblerTemplate">AssemblerTemplate</a></li>
                <li>
                    <a href="#outputoperands" aria-label="OutputOperands">OutputOperands</a><ul>
                        
                <li>
                    <a href="#asmsymbolicname" aria-label="asmSymbolicName">asmSymbolicName</a></li>
                <li>
                    <a href="#constraint" aria-label="constraint">constraint</a></li>
                <li>
                    <a href="#cvariablename" aria-label="cvariablename">cvariablename</a></li></ul>
                </li>
                <li>
                    <a href="#inputoperands" aria-label="InputOperands">InputOperands</a><ul>
                        
                <li>
                    <a href="#asmsymbolicname-1" aria-label="asmSymbolicName">asmSymbolicName</a></li></ul>
                </li>
                <li>
                    <a href="#clobbers" aria-label="Clobbers">Clobbers</a></li>
                <li>
                    <a href="#gotolabels" aria-label="GotoLabels">GotoLabels</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e4%be%8b" aria-label="实例">实例</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="参考资料">参考资料</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>高中第一次看到在 C 语言中嵌入汇编语言时，我就觉得它非常好玩，到大学刚开学的时候，我甚至有使用它的需求，可惜直到现在我才抽出时间开始学习它。</p>
<h2 id="分类">分类<a hidden class="anchor" aria-hidden="true" href="#分类">#</a></h2>
<p>在 GNU 的 GCC 中，内联汇编被分为两类：<strong>Basic asm</strong> 和 <strong>Extended asm</strong> 。</p>
<p>GCC 的官方文档中写到，在函数中混合使用 C 语言和汇编语言时，最好使用扩展形式；但是要在顶层(top level)包含汇编语言，则必须使用基本形式。</p>
<p>这里的 <strong>top level</strong> 一词非常诡异，让我摸不着头脑，之后我在官方文档的后文发现了蛛丝马迹：</p>
<p>两种必须使用 Basic asm 的情形：</p>
<ul>
<li>Extended asm 声明必须在 C 函数内，所以如果在文件作用域(top-level)，在函数之外使用汇编，必须使用 Basic asm 。你可以使用此技术发出汇编程序指令，定义可在文件的其他位置调用的汇编语言宏，或用汇编语言编写整个函数。</li>
<li>函数的属性(attribute)被声明为 naked 时必须使用 Basic asm 。</li>
</ul>
<blockquote>
<p>naked attribute 在此不做展开。</p>
</blockquote>
<p>谜底揭开了，原来 top level 指的就是文件这一层。</p>
<h2 id="basic-asm">Basic asm<a hidden class="anchor" aria-hidden="true" href="#basic-asm">#</a></h2>
<p>可以使用关键字 <code>asm</code> 来声明一段内联汇编，不过这是 GNU 的拓展，如果在编译条件中使用了 <code>-std</code> 或者 <code>-ansi</code> 时，必须使用 <code>__asm__</code> 。</p>
<h3 id="修饰">修饰<a hidden class="anchor" aria-hidden="true" href="#修饰">#</a></h3>
<p>可以使用 <code>volatile</code> 和 <code>inline</code> 来修饰，不过 <code>volatile</code> 没有作用，所有的内联汇编代码段都是默认 <code>volatile</code> 的。如果使用 <code>inline</code> ，那么为了内联的目的，内联汇编语句的大小被当作是可能的最小大小。</p>
<p>这里涉及到了内联汇编的大小估计，这是因为内联汇编生成的最终代码只由汇编器(Assembler)知晓，所以编译器需要自己估算，通过查找 <code>'\n\t'</code>, <code>';'</code> 等符号来估计指令数（行数），再乘以可能的最长指令长度来获得估算大小。所以如果在 <code>inline</code> 的 Basic asm 中使用了伪指令等能生成汇编语句的成分，汇编器可能会报错 unreachable 。</p>
<blockquote>
<p>是否需要估计内联汇编的大小，这个与平台有关。</p>
</blockquote>
<h3 id="参数">参数<a hidden class="anchor" aria-hidden="true" href="#参数">#</a></h3>
<p>又被称为 <code>AssemblerTemplate</code> ，由字符串字面值组成，该字符串由汇编语句组成，可以包括伪指令，GCC 的编译器并不检查它们的有效性，指令会被直接传递到汇编器中。</p>
<p>在一段内联汇编中使用多条汇编语句时要注意自己使用的是什么汇编器（以及它们使用的是何种汇编方言），一般都可以用 <code>'\n\t'</code> 来分隔，有些汇编器可以使用 <code>';'</code> ，但要注意在这种汇编方言中分号是不是注释开始的符号。</p>
<h3 id="注意">注意<a hidden class="anchor" aria-hidden="true" href="#注意">#</a></h3>
<ul>
<li>
<p>由于调用函数以及访问 C 数据可能很复杂，在这种情况下使用 Extended asm 是更好的选择。</p>
</li>
<li>
<p>在编译器优化后连续的 asm 声明可能不再连续，所以如要需要连续语句，请写在同一个 asm 语句中。尤其是两个 asm 声明中包含了跳转时，如果被编译器调整顺序则会产生意想不到的后果。如果要跳转到 C 标签，还是使用 Extended asm 更好。</p>
</li>
<li>
<p>如果在汇编语句中定义了符号或者标签，可能会导致重复符号的错误。</p>
</li>
</ul>
<h2 id="extended-asm">Extended asm<a hidden class="anchor" aria-hidden="true" href="#extended-asm">#</a></h2>
<p>拓展内联汇编有两种模板：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">asm</span> <span style="color:#fff;font-weight:bold">asm</span>-qualifiers ( AssemblerTemplate 
</span></span><span style="display:flex;"><span>                 : OutputOperands 
</span></span><span style="display:flex;"><span>                 [ : InputOperands
</span></span><span style="display:flex;"><span>                 [ : Clobbers ] ])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">asm</span> <span style="color:#fff;font-weight:bold">asm</span>-qualifiers ( AssemblerTemplate 
</span></span><span style="display:flex;"><span>                      : OutputOperands
</span></span><span style="display:flex;"><span>                      : InputOperands
</span></span><span style="display:flex;"><span>                      : Clobbers
</span></span><span style="display:flex;"><span>                      : GotoLabels)
</span></span></code></pre></div><p>同样地，在不使用 GNU 拓展时要用 <code>__asm__</code> 代替 <code>asm</code>。</p>
<h3 id="修饰-1">修饰<a hidden class="anchor" aria-hidden="true" href="#修饰-1">#</a></h3>
<p>除了 <code>volatile</code> 和 <code>inline</code> 外，还有 <code>goto</code> ，表示这段内联汇编代码可能会跳转到 <code>GotoLabels</code> 中的某一个标签上。</p>
<h3 id="参数-1">参数<a hidden class="anchor" aria-hidden="true" href="#参数-1">#</a></h3>
<p><code>input</code>, <code>output</code>, <code>goto</code> 的操作数加起来不能超过 30 个。</p>
<h4 id="assemblertemplate">AssemblerTemplate<a hidden class="anchor" aria-hidden="true" href="#assemblertemplate">#</a></h4>
<p>同样是由字符串字面值组成，但是里面包含了一些标识符，它们指向了 <code>output</code>, <code>input</code>, <code>goto</code> 中的操作数。</p>
<h4 id="outputoperands">OutputOperands<a hidden class="anchor" aria-hidden="true" href="#outputoperands">#</a></h4>
<blockquote>
<p>不能将其单纯理解为输出，而是理解为会被修改的变量。</p>
</blockquote>
<p>由 <code>AssemblerTemplate</code> 中的指令修改的 C 变量列表，由逗号分隔，可以为空。</p>
<p>结构一般为：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[ [asmSymbolicName]  ] constraint (cvariablename)
</span></span></code></pre></div><h5 id="asmsymbolicname">asmSymbolicName<a hidden class="anchor" aria-hidden="true" href="#asmsymbolicname">#</a></h5>
<p>可以理解为在这段拓展内联汇编中的符号别名，它可以和上下文中的 C 语言符号重复，也可以和其他内联汇编代码中的符号名重复。在 <code>AssemblerTemplate</code> 中的使用方法为 <code>%[Value]</code>。</p>
<p>如果不使用符号别名，则必须使用位置编号来指示符号，例如 <code>OutputOperands</code> 中有三项，则用 <code>%0</code>, <code>%1</code> 和 <code>%2</code> 表示。</p>
<h5 id="constraint">constraint<a hidden class="anchor" aria-hidden="true" href="#constraint">#</a></h5>
<p>Output 的约束修饰符必须是以 <code>'='</code> 开始（表示将会覆写这个变量），如果这个变量既被读也被写就需要 <code>'+'</code> 。当使用 <code>'='</code> 时不要假定可以读取到将被覆写的变量的当前值，除非这个变量也在 Input 列表中。</p>
<p>使用了 <code>'+'</code> 的操作数视作两个（在计算总个数及位置时）。</p>
<p>还需要对值所在的位置进行约束，例如 <code>'r'</code> 表示寄存器，<code>'m'</code> 表示在内存。如果使用了一个以上的位置约束修饰符，编译器会选择它认为最好的方式进行优化。</p>
<p>也可以使用数字进行约束，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">asm</span> (<span style="color:#0ff;font-weight:bold">&#34;incl %0&#34;</span> :<span style="color:#0ff;font-weight:bold">&#34;=a&#34;</span>(var):<span style="color:#0ff;font-weight:bold">&#34;0&#34;</span>(var));
</span></span></code></pre></div><p>表示输入中的 <code>var</code> 使用的是和输出中的 <code>var</code> 相同的约束，这里的 0 表示为编号为 0 的操作数。</p>
<p>常用的约束：</p>
<table>
  <thead>
      <tr>
          <th>符号</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>I</td>
          <td>a constant</td>
      </tr>
      <tr>
          <td>a</td>
          <td>use eax</td>
      </tr>
      <tr>
          <td>b</td>
          <td>use ebx</td>
      </tr>
      <tr>
          <td>c</td>
          <td>use ecx</td>
      </tr>
      <tr>
          <td>d</td>
          <td>use edx</td>
      </tr>
      <tr>
          <td>S</td>
          <td>use esi</td>
      </tr>
      <tr>
          <td>D</td>
          <td>use edi</td>
      </tr>
      <tr>
          <td>r</td>
          <td>use one of eax, ebx, ecx or edx</td>
      </tr>
      <tr>
          <td>q</td>
          <td>use one of eax, ebx, ecx, edx, esi or edi</td>
      </tr>
  </tbody>
</table>
<p>其余见 GCC 文档。</p>
<h5 id="cvariablename">cvariablename<a hidden class="anchor" aria-hidden="true" href="#cvariablename">#</a></h5>
<p>一个 C 左值表达式，一般为变量。</p>
<h4 id="inputoperands">InputOperands<a hidden class="anchor" aria-hidden="true" href="#inputoperands">#</a></h4>
<blockquote>
<p>不能将其单纯理解为输入，而是理解为会被读取的变量。</p>
</blockquote>
<p>由 <code>AssemblerTemplate</code> 中的指令读取的 C 表达式列表，由逗号分隔，可以为空。</p>
<p>结构也为：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[ [asmSymbolicName]  ] constraint (cvariablename)
</span></span></code></pre></div><h5 id="asmsymbolicname-1">asmSymbolicName<a hidden class="anchor" aria-hidden="true" href="#asmsymbolicname-1">#</a></h5>
<p>如果有两个输入操作数，三个输出操作数，则第一个输入操作数为 <code>%2</code> ，第二个为 <code>%3</code> ，第三个为 <code>%4</code> 。</p>
<p>一个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">asm</span> (<span style="color:#0ff;font-weight:bold">&#34;cmoveq %1, %2, %[result]&#34;</span> 
</span></span><span style="display:flex;"><span>        : [result] <span style="color:#0ff;font-weight:bold">&#34;=r&#34;</span>(result) 
</span></span><span style="display:flex;"><span>        : <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span> (test), <span style="color:#0ff;font-weight:bold">&#34;r&#34;</span> (new), <span style="color:#0ff;font-weight:bold">&#34;[result]&#34;</span> (old));
</span></span></code></pre></div><h4 id="clobbers">Clobbers<a hidden class="anchor" aria-hidden="true" href="#clobbers">#</a></h4>
<blockquote>
<p>In software engineering and computer science, clobbering a file, processor register or a region of computer memory is the process of overwriting its contents completely, whether intentionally or unintentionally, or to indicate that such an action will likely occur.</p>
</blockquote>
<p>以逗号分隔的寄存器列表，一般为 <code>AssemblerTemplate</code> 更改的其他值（没有被列入 <code>OutputOperands</code> 的部分）。例如一些汇编指令（例如 <code>cld</code> ）有副作用，会使用到额外的寄存器。</p>
<p>有两个特殊的 clobber ：</p>
<ul>
<li>
<p><code>cc</code> - 表示将会修改 flag 寄存器。</p>
</li>
<li>
<p><code>memory</code> - 这个 clobber 可以告诉编译器，这段内联汇编代码将对输入和输出操作数之外的项执行内存读取或写入操作（例如，输入操作数是一个指针，需要访问它指向的内存）。</p>
</li>
</ul>
<p>使用 <code>memory</code> 时，为了确保内存中包含正确的值，GCC 可能需要在执行这段内联汇编之前，将特定的寄存器值刷新到内存中。</p>
<p>此外，在执行一个提前读取操作之前，编译器不会假定从内存中读取的值在执行该提前读取操作之后保持不变，而是会根据需要重新加载这些值。</p>
<p><code>memory</code> 这个 clobber 有效地为编译器形成了读/写内存障碍。但这并不能阻止处理器在内联汇编语句之后执行推测性读操作。这种情况下还是需要 <code>fence</code> 指令。</p>
<h4 id="gotolabels">GotoLabels<a hidden class="anchor" aria-hidden="true" href="#gotolabels">#</a></h4>
<p>此部分包含 C 标签的列表，当使用 <code>goto</code> 形式时，<code>AssemblerTemplate</code> 中的代码可以跳转到这些标签。</p>
<p>要引用汇编程序模板中的标签，需要在它前面加上 <code>'l'</code> ，后面加上它在 <code>GotoLabels</code> 中的位置与输入和输出操作数的数目之和。带约束修饰符 <code>'+'</code> 的输出操作数被视为两个操作数。例如，如果有三个输入操作数，一个输出操作数带有约束修饰符 <code>'+'</code>，一个输出操作数带有约束修饰符 <code>'='</code> ，那么 <code>GotoLabels</code> 的第一个标签称为 <code>%l6</code> ，第二个称为 <code>%l7</code> 。</p>
<p>也可以使用实际的 C 标签名，例如如果要引用 <code>GotoLabels</code> 中的 <code>carry</code> 标签，可以使用 <code>%l[carry]</code> ，这也是推荐的方法，避免了对编号的计算。</p>
<h2 id="实例">实例<a hidden class="anchor" aria-hidden="true" href="#实例">#</a></h2>
<p>两数之和：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">int</span> foo = <span style="color:#ff0;font-weight:bold">10</span>, bar = <span style="color:#ff0;font-weight:bold">15</span>;
</span></span><span style="display:flex;"><span>    __asm__ __volatile__(<span style="color:#0ff;font-weight:bold">&#34;addl  %%ebx,%%eax&#34;</span>
</span></span><span style="display:flex;"><span>                         :<span style="color:#0ff;font-weight:bold">&#34;=a&#34;</span>(foo)
</span></span><span style="display:flex;"><span>                         :<span style="color:#0ff;font-weight:bold">&#34;a&#34;</span>(foo), <span style="color:#0ff;font-weight:bold">&#34;b&#34;</span>(bar)
</span></span><span style="display:flex;"><span>                         );
</span></span><span style="display:flex;"><span>    printf(<span style="color:#0ff;font-weight:bold">&#34;foo+bar=%d</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, foo);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>或者：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> __asm__ __volatile__(
</span></span><span style="display:flex;"><span>                      <span style="color:#0ff;font-weight:bold">&#34;   lock       ;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#0ff;font-weight:bold">&#34;   addl %1,%0 ;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>                      : <span style="color:#0ff;font-weight:bold">&#34;=m&#34;</span>  (my_var)
</span></span><span style="display:flex;"><span>                      : <span style="color:#0ff;font-weight:bold">&#34;ir&#34;</span>  (my_int), <span style="color:#0ff;font-weight:bold">&#34;m&#34;</span> (my_var)
</span></span><span style="display:flex;"><span>                      :                                 <span style="color:#007f7f">/* no clobber-list */</span>
</span></span><span style="display:flex;"><span>                      );
</span></span></code></pre></div><p><code>lock</code> 表示这是个原子操作。</p>
<p>字符串复制：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">inline</span> <span style="color:#fff;font-weight:bold">char</span> * strcpy(<span style="color:#fff;font-weight:bold">char</span> * dest,<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *src)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">int</span> d0, d1, d2;
</span></span><span style="display:flex;"><span>__asm__ __volatile__(  <span style="color:#0ff;font-weight:bold">&#34;1:</span><span style="color:#0ff;font-weight:bold">\t</span><span style="color:#0ff;font-weight:bold">lodsb</span><span style="color:#0ff;font-weight:bold">\n\t</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#0ff;font-weight:bold">&#34;stosb</span><span style="color:#0ff;font-weight:bold">\n\t</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#0ff;font-weight:bold">&#34;testb %%al,%%al</span><span style="color:#0ff;font-weight:bold">\n\t</span><span style="color:#0ff;font-weight:bold">&#34;</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#0ff;font-weight:bold">&#34;jne 1b&#34;</span>
</span></span><span style="display:flex;"><span>                     : <span style="color:#0ff;font-weight:bold">&#34;=&amp;S&#34;</span> (d0), <span style="color:#0ff;font-weight:bold">&#34;=&amp;D&#34;</span> (d1), <span style="color:#0ff;font-weight:bold">&#34;=&amp;a&#34;</span> (d2)
</span></span><span style="display:flex;"><span>                     : <span style="color:#0ff;font-weight:bold">&#34;0&#34;</span> (src),<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span> (dest) 
</span></span><span style="display:flex;"><span>                     : <span style="color:#0ff;font-weight:bold">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">return</span> dest;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define mov_blk(src, dest, numwords) \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">__asm__ __volatile__ (                                          \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       &#34;cld\n\t&#34;                                \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       &#34;rep\n\t&#34;                                \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       &#34;movsl&#34;                                  \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       :                                        \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       : &#34;S&#34; (src), &#34;D&#34; (dest), &#34;c&#34; (numwords)  \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       : &#34;%ecx&#34;, &#34;%esi&#34;, &#34;%edi&#34;                 \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                       )
</span></span></span></code></pre></div><p>Linux 系统调用：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">#define _syscall3(type,name,type1,arg1,type2,arg2,type3,arg3) \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">type name(type1 arg1,type2 arg2,type3 arg3) \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">{ \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">long __res; \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">__asm__ volatile (  &#34;int $0x80&#34; \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                  : &#34;=a&#34; (__res) \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                  : &#34;0&#34; (__NR_##name),&#34;b&#34; ((long)(arg1)),&#34;c&#34; ((long)(arg2)), \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">                    &#34;d&#34; ((long)(arg3))); \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">__syscall_return(type,__res); \
</span></span></span><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">}
</span></span></span></code></pre></div><p>Linux 退出：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">asm</span>(<span style="color:#0ff;font-weight:bold">&#34;movl $1,%%eax;         /* SYS_exit is 1 */</span>
</span></span><span style="display:flex;"><span>         xorl %%ebx,%%ebx;      <span style="color:#007f7f">/* Argument is in ebx, it is 0 */</span>
</span></span><span style="display:flex;"><span>         <span style="color:#fff;font-weight:bold">int</span>  <span style="color:#f00">$</span><span style="color:#ff0;font-weight:bold">0x80</span><span style="color:#0ff;font-weight:bold">&#34;            /* Enter kernel mode */</span>
</span></span><span style="display:flex;"><span>         );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="参考资料">参考资料<a hidden class="anchor" aria-hidden="true" href="#参考资料">#</a></h2>
<p>内联汇编深入起来非常繁杂，有些功能需要使用的时候可以直接查看 GNU 的文档。</p>
<p><a href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">GCC Inline Assembly HOWTO</a></p>
<p><a href="https://web.archive.org/web/20110514100544/http://gcc.gnu.org/onlinedocs/gnat_ugn_unw/Inline-Assembler.html">GCC doc in web archive</a></p>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html#Using-Assembly-Language-with-C">How to Use Inline Assembly Language in C Code</a></p>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Basic-Asm.html#Basic-Asm">Basic Asm</a></p>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">Extended Asm</a></p>
<p><a href="https://dmalcolm.fedorapeople.org/gcc/2015-08-31/rst-experiment/how-to-use-inline-assembly-language-in-c-code.html">How to Use Inline Assembly Language in C Code</a></p>
<p><a href="https://dmalcolm.fedorapeople.org/gcc/2015-08-31/rst-experiment/declaring-attributes-of-functions.html">Declaring Attributes of Functions</a></p>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Local-Register-Variables.html">Local Register Variables</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://vaaandark.top/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/">汇编语言</a></li>
      <li><a href="https://vaaandark.top/tags/c%E8%AF%AD%E8%A8%80/">C语言</a></li>
      <li><a href="https://vaaandark.top/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a></li>
      <li><a href="https://vaaandark.top/tags/gcc/">GCC</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://vaaandark.top/posts/sqlite-introduction/">
    <span class="title">« 上一页</span>
    <br>
    <span>SQLite 入门（持续更新）</span>
  </a>
  <a class="next" href="https://vaaandark.top/posts/2022-bilibili-report/">
    <span class="title">下一页 »</span>
    <br>
    <span>2022 Bilibili 年度报告</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on x"
            href="https://x.com/intent/tweet/?text=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f&amp;hashtags=%e6%b1%87%e7%bc%96%e8%af%ad%e8%a8%80%2cC%e8%af%ad%e8%a8%80%2c%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80%2cGCC">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f&amp;title=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96&amp;summary=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96&amp;source=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f&title=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on whatsapp"
            href="https://api.whatsapp.com/send?text=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96%20-%20https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on telegram"
            href="https://telegram.me/share/url?text=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 内联汇编 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e5%86%85%e8%81%94%e6%b1%87%e7%bc%96&u=https%3a%2f%2fvaaandark.top%2fposts%2finline-assembly%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><script src="https://giscus.app/client.js"
        data-repo="vaaandark/vaaandark.github.io"
        data-repo-id="R_kgDOGsxTxw"
        data-category="Announcements"
        data-category-id="DIC_kwDOGsxTx84CmAQ1"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://vaaandark.top/">vaaandark&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
