<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Pthread | vaaandark&#39;s blog</title>
<meta name="keywords" content="Linux, glibc, HPC">
<meta name="description" content="
赛博考古：Linux 支持 POSIX 线程标准的前世今生

线程是什么
操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。">
<meta name="author" content="vaaandark">
<link rel="canonical" href="https://vaaandark.top/posts/pthread/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.556a50c7c92c2556e588f602528ac3c41884cdb6e537ce0647b5e200cd1c2094.css" integrity="sha256-VWpQx8ksJVbliPYCUorDxBiEzbblN84GR7XiAM0cIJQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://vaaandark.top/image/vaaandark.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://vaaandark.top/image/vaaandark.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://vaaandark.top/image/vaaandark.png">
<link rel="apple-touch-icon" href="https://vaaandark.top/image/vaaandark.png">
<link rel="mask-icon" href="https://vaaandark.top/image/vaaandark.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://vaaandark.top/posts/pthread/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://vaaandark.top/posts/pthread/">
  <meta property="og:site_name" content="vaaandark&#39;s blog">
  <meta property="og:title" content="Pthread">
  <meta property="og:description" content=" 赛博考古：Linux 支持 POSIX 线程标准的前世今生
线程是什么 操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-23T22:03:25+08:00">
    <meta property="article:modified_time" content="2023-12-23T22:03:25+08:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Glibc">
    <meta property="article:tag" content="HPC">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pthread">
<meta name="twitter:description" content="
赛博考古：Linux 支持 POSIX 线程标准的前世今生

线程是什么
操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://vaaandark.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Pthread",
      "item": "https://vaaandark.top/posts/pthread/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Pthread",
  "name": "Pthread",
  "description": " 赛博考古：Linux 支持 POSIX 线程标准的前世今生\n线程是什么 操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。\n",
  "keywords": [
    "Linux", "glibc", "HPC"
  ],
  "articleBody": " 赛博考古：Linux 支持 POSIX 线程标准的前世今生\n线程是什么 操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。\n线程共享了什么 代码段、数据段、堆 文件描述符 进程信息（如 pid ）、用户 id 和组 id Signal Handle 线程没有共享什么 栈 寄存器 线程优先级和调度策略 TLS(Thread Local Storage)（线程局部存储） tid(可以使用 syscall(SYS_gettid) 查看) Signal Mask 值得注意的问题(pid vs tgid, getpid vs gettid) tg for thread group\ngetpid 是 man 3 里面的，因此它是 Library call ；gettid 是 man 2 里面的，因此它是 System Call 。\n我们使用 unistd.h 中的 getpid() 实际上获取的是 tgid ，而 syscall(SYS_gettid) 实际上获取的是 pid 。\n如图所示，每个线程都有独一无二的 pid ，有可能重复的 tgid 。当一个进程属于一个单线程程序时，它的 pid 就等于 tgid ；当它创建了一个线程时，新的线程拥有一个新的 pid ，同时继承了同一线程组的 tgid 。\nUSER VIEW \u003c-- PID 43 --\u003e|\u003c----------------- PID 42 -----------------\u003e | +---------+ | | | process | | | _| pid=42 |_ | __(fork) _/ | tgid=42 | \\_ (new thread) _ / | +---------+ | \\ +---------+ | | +---------+ | process | | | | process | | pid=43 | | | | pid=44 | | tgid=43 | | | | tgid=42 | +---------+ | | +---------+ \u003c-- PID 43 --\u003e|\u003c--------- PID 42 --------\u003e|\u003c--- PID 44 ---\u003e KERNEL VIEW POSIX Thread 与其说是 pthread 的历史，不如说是 kernel 变得更大更强，对线程模型支持得更好的历史。\nLinuxThreads（早期） NPTL(Native POSIX Thread Library)（现在） 查看你的 pthread 实现：\n$ getconf GNU_LIBPTHREAD_VERSION NPTL 2.38 LinuxThreads 在 Linux 操作系统中， LinuxThreads 是 1996 年推出的 POSIX Threads 的部分实现，其主要开发者是 Xavier Leroy 。\n管理线程(Manager Thread) 为什么需要管理线程？\n对致命的信号做出反应(fatal signals)，并杀死或终止整个线程。（后文详细说明这一点的原因，这是由 LinuxThreads 的缺陷导致的） 释放用作线程栈的内存不能由该线程本身执行，必须要等这个线程结束再进行，因此需要特殊的管理线程来收尾。 释放 tls 需要遍历所有线程，因此需要管理线程。 终止线程必须是等待的（由管理线程等待），不然会出现僵尸线程。 当主线程调用 pthread_exit() 时，这个进程不能就此结束。正确的行为是，主线程 sleep ，当其他线程被杀死后管理线程再唤醒主线程，主线程此时才能退出。 缺陷 管理线程带来的额外开销。 使用信号实现同步原语。 基本符合 POSIX 标准，信号处理除外。 LinuxThreads 实现的线程，本质上是共享了内存、文件描述符的进程，它们有着不同的 pid ，它们并不作为进程的一个整体：\n这里的 pid 是抽象概念，当时的 Kernel 并没有 pid 和 tgid 的区别。\n发送到线程 pid 的信号只能由该线程处理。只要没有线程阻塞该信号，该行为就符合标准：程序的一个（未指定）线程处理该信号。 但是，如果向 pid 发送信号的线程阻塞了信号，那么 LinuxThreads 将简单地在该线程中排队，仅当该线程解除阻塞信号时才执行处理程序，而不是立即在不阻塞信号的另一个线程中执行。 实现者的吐槽：This is to be viewed as a LinuxThreads bug, but I currently don’t see any way to implement the POSIX behavior without kernel support.\n线程模型 此时就已经出现了 Linux 代表性的一对一(one-to-one)模型。内核对线程和进程不做区分，所谓的内核线程是 task_struct ，而内核调度时也只考虑它们。\none-to-one vs many-to-one 当用户创建出很多用户线程时， Linux 的做法是：每当用户调用库函数创建线程，库函数让内核创建出一个新的内核线程。\n多处理器上，CPU 密集型程序的开销最小，即每个处理器上都可以跑一个线程（思考一下如果是 many-to-one ，一个内核线程对应多个用户线程，则很难在多核上并行）。 I/O 操作开销最小（思考一下如果是 many-to-one ，阻塞 IO 操作实现起来有多么复杂）。 实现简单，不与内核过度耦合（内核调度可以完成大部分复杂工作）。 one-to-one vs many-to-many 那么为什么不用多对多模型呢？\n当时大多数商业 Unix 系统（Solaris、Digital Unix、IRIX）都以这种方式实现 POSIX 线程。该模型结合了“多对一”和“一对一”模型的优点，很有吸引力。\n多对多模型能成功避免两种模型的最坏情况。在上下文切换成本高昂的内核 Digital Unix 上多对多模型几乎可以说是唯一选择。\n但是，多对多模型的实现相当复杂，并且需要 Linux 增加支持很多新的功能。另一方面，Linus Torvalds 和其他 Linux 内核开发人员一直以整体简单性的名义推动一对一模型，更何况 Linux 的上下文切换效率相当出色。\n虽然多对多模型在 pthread 中被放弃，但是它在一些编程语言的运行时中大放异彩。\n管理线程与一对一模型结合导致的问题 管理线程只能在一个核上运行，这导致加速比变低，性能变差。 由于整个系统围绕着管理线程设计，上下文切换开销变大。 NPTL 为了解决 LinuxThreads 的一些问题，内核开发人员设计实现了 NPTL(Native POSIX Thread Library) 。\nNPTL 完全兼容 POSIX 标准。 NPTL 在多处理器机器上效果也很好。 NPTL 的启动开销不大。 NPTL 也能利用到 NUMA 架构的优势。 NPTL 和 LinuxThreads 二进制兼容（LD 实现的）。 利用了新的内核特性 NPTL 无需管理线程： 不需要转发 fatal signal 的工作，内核可以处理好向某一进程发送信号的工作。 不需要由管理线程析构，内核可以处理线程内存的释放。 不需要管理线程来避免僵尸线程，内核可以在清理父线程前等待所有线程。 去掉管理线程，对 SMP 和 NUMA 更友好。 使用 futex 来实现同步，而且 futex 可以在进程间共享，能在更多场景使用。 NPTL 的每个线程都有自己的父线程，在进行资源统计时便于统计整个进程，此前的 LinuxThreads 不能做到。 如何实现 TLS 我们都知道在写声明时加入 __thread 可以声明一个线程局部变量。那它是如何实现的呢？\n在早期 LinuxThreads 的实现中， TLS 直接放在线程栈旁边。而在引入 NPTL 后，各个 libc （如 glibc, uClibc, musl）都是使用新增的 ELF 标准对 TLS 的支持和动态链接器来实现的。\n查看一个 __thread 声明的汇编代码时，我们可能看到 mov %fs:0xfffffffffffffffc,%eax 。\n这也就是 mov %fs:-4,%eax 。\n这是什么？这太奇怪了！\n虽然某些 CPU 架构有专用的寄存器来保存线程特定的上下文，但 x86 没有。众所周知，x86 只有少量的通用寄存器。\n英特尔 80386 引入了 FS 和 GS 作为用户定义的段寄存器，但没有规定它们的用途。然而，随着多线程编程的兴起，人们看到了重新利用 FS 和 GS 的机会，并开始将它们用作线程寄存器。\nTLS 的结构：\n使用 dlopen 加载的 DSO(动态共享对象) 放在动态 TLS 中，其余的放在静态 TLS 中。 $dtv_t$ 可以看作是一个二维数组，可以通过模块 id 和偏移量对任何 TLS 变量进行寻址。TLS 变量偏移量是模块中的本地偏移量，模块 id 是进程中加载的 ELF 对象的索引号。 访问一个 TLS 变量的通用方法：\ndtv[-1].counter; /* Pro tip: The length of this dtv array */ dtv[0].counter; /* Generation counter for the DTV in this thread */ dtv[1].pointer; /* Pointer to the main executable TLS block in this thread */ /* Pointer to a TLS variable defined in a module id `ti_module` */ main_tls_var = *(dtv[tls_index.ti_module].pointer + tls_index.ti_offset); 编译器和动态链接器共同计算出地址，因为可执行文件的 TLS 块和 TLS 偏移量都是提前知道的。\n这种合作依赖于编译器在构建时的以下「事实」：\nFS 寄存器指向 TCB 。 编译器设置的 TLS 变量偏移量在运行时不会更改。 可执行文件的 TLS 块位于 TCB 之前。 同时，将 TLS 放在 TCB 之前可以让经常被访问的内存更持久地留在缓存中。\nReference LinuxThreads Frequently Asked Questions Linux threading models compared: LinuxThreads and NPTL NPTL design uClibc NPTL design ELF Handling for Thread-Local Storage All about thread-local storage A Deep dive into (implicit) Thread Local Storage ",
  "wordCount" : "2564",
  "inLanguage": "zh",
  "datePublished": "2023-12-23T22:03:25+08:00",
  "dateModified": "2023-12-23T22:03:25+08:00",
  "author":{
    "@type": "Person",
    "name": "vaaandark"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vaaandark.top/posts/pthread/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "vaaandark's blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vaaandark.top/image/vaaandark.png"
    }
  }
}
</script>

<script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"]],
    },
    displayMath: [
      ["$$", "$$"],
      ["\[\[", "\]\]"],
    ],
    svg: {
      fontCache: "global",
    },
  };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
></script>


</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://vaaandark.top/" accesskey="h" title="vaaandark&#39;s blog (Alt + H)">
                <img src="https://vaaandark.top/image/vaaandark.png" alt="" aria-label="logo"
                    height="35">vaaandark&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://vaaandark.top/" title="🏠主页">
                    <span>🏠主页</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/posts/" title="Posts">
                    <span>📄 归档</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/categories/" title="categories">
                    <span>📂 分类</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/tags/" title="tags">
                    <span>🔖 标签</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/about/" title="关于我">
                    <span>🙋 关于</span>
                </a>
            </li>
            <li>
                <a href="https://vaaandark.top/links/" title="友链">
                    <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://vaaandark.top/">主页</a>&nbsp;»&nbsp;<a href="https://vaaandark.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Pthread
    </h1>
    <div class="post-meta"><span title='2023-12-23 22:03:25 +0800 CST'>2023 12月 23</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;vaaandark

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%98%af%e4%bb%80%e4%b9%88" aria-label="线程是什么">线程是什么</a><ul>
                        
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e5%85%b1%e4%ba%ab%e4%ba%86%e4%bb%80%e4%b9%88" aria-label="线程共享了什么">线程共享了什么</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%b2%a1%e6%9c%89%e5%85%b1%e4%ba%ab%e4%bb%80%e4%b9%88" aria-label="线程没有共享什么">线程没有共享什么</a></li>
                <li>
                    <a href="#%e5%80%bc%e5%be%97%e6%b3%a8%e6%84%8f%e7%9a%84%e9%97%ae%e9%a2%98pid-vs-tgid-getpid-vs-gettid" aria-label="值得注意的问题(pid vs tgid, getpid vs gettid)">值得注意的问题(pid vs tgid, getpid vs gettid)</a></li></ul>
                </li>
                <li>
                    <a href="#posix-thread" aria-label="POSIX Thread">POSIX Thread</a><ul>
                        
                <li>
                    <a href="#linuxthreads" aria-label="LinuxThreads">LinuxThreads</a><ul>
                        
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e7%ba%bf%e7%a8%8bmanager-thread" aria-label="管理线程(Manager Thread)">管理线程(Manager Thread)</a></li>
                <li>
                    <a href="#%e7%bc%ba%e9%99%b7" aria-label="缺陷">缺陷</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%a8%a1%e5%9e%8b" aria-label="线程模型">线程模型</a><ul>
                        
                <li>
                    <a href="#one-to-one-vs-many-to-one" aria-label="one-to-one vs many-to-one">one-to-one vs many-to-one</a></li>
                <li>
                    <a href="#one-to-one-vs-many-to-many" aria-label="one-to-one vs many-to-many">one-to-one vs many-to-many</a></li>
                <li>
                    <a href="#%e7%ae%a1%e7%90%86%e7%ba%bf%e7%a8%8b%e4%b8%8e%e4%b8%80%e5%af%b9%e4%b8%80%e6%a8%a1%e5%9e%8b%e7%bb%93%e5%90%88%e5%af%bc%e8%87%b4%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="管理线程与一对一模型结合导致的问题">管理线程与一对一模型结合导致的问题</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#nptl" aria-label="NPTL">NPTL</a><ul>
                        
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e4%ba%86%e6%96%b0%e7%9a%84%e5%86%85%e6%a0%b8%e7%89%b9%e6%80%a7" aria-label="利用了新的内核特性">利用了新的内核特性</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0-tls" aria-label="如何实现 TLS">如何实现 TLS</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>赛博考古：Linux 支持 POSIX 线程标准的前世今生</p>
</blockquote>
<h2 id="线程是什么">线程是什么<a hidden class="anchor" aria-hidden="true" href="#线程是什么">#</a></h2>
<p>操作系统能够进行运算调度的最小单位。在一般的操作系统上，它被包含在进程之中，是进程中的实际运作单位。</p>
<h3 id="线程共享了什么">线程共享了什么<a hidden class="anchor" aria-hidden="true" href="#线程共享了什么">#</a></h3>
<ul>
<li>代码段、数据段、堆</li>
<li>文件描述符</li>
<li>进程信息（如 pid ）、用户 id 和组 id</li>
<li>Signal Handle</li>
</ul>
<h3 id="线程没有共享什么">线程没有共享什么<a hidden class="anchor" aria-hidden="true" href="#线程没有共享什么">#</a></h3>
<ul>
<li>栈</li>
<li>寄存器</li>
<li>线程优先级和调度策略</li>
<li>TLS(Thread Local Storage)（线程局部存储）</li>
<li>tid(可以使用 <code>syscall(SYS_gettid)</code> 查看)</li>
<li>Signal Mask</li>
</ul>
<h3 id="值得注意的问题pid-vs-tgid-getpid-vs-gettid">值得注意的问题(pid vs tgid, getpid vs gettid)<a hidden class="anchor" aria-hidden="true" href="#值得注意的问题pid-vs-tgid-getpid-vs-gettid">#</a></h3>
<blockquote>
<p>tg for thread group</p>
</blockquote>
<p><code>getpid</code> 是 man 3 里面的，因此它是 Library call ；<code>gettid</code> 是 man 2 里面的，因此它是 System Call 。</p>
<p>我们使用 <code>unistd.h</code> 中的 <code>getpid()</code> 实际上获取的是 tgid ，而 <code>syscall(SYS_gettid)</code> 实际上获取的是 pid 。</p>
<p>如图所示，每个线程都有独一无二的 pid ，有可能重复的 tgid 。当一个进程属于一个单线程程序时，它的 pid 就等于 tgid ；当它创建了一个线程时，新的线程拥有一个新的 pid ，同时继承了同一线程组的 tgid 。</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>                         USER VIEW
</span></span><span style="display:flex;"><span>&lt;-- PID 43 --&gt;|&lt;----------------- PID 42 -----------------&gt;
</span></span><span style="display:flex;"><span>              |      +---------+          |
</span></span><span style="display:flex;"><span>              |      | process |          |
</span></span><span style="display:flex;"><span>              |     _| pid=42  |_         |
</span></span><span style="display:flex;"><span>         __(fork) _/ | tgid=42 | \_ (new thread) _
</span></span><span style="display:flex;"><span>        /     |      +---------+          |       \
</span></span><span style="display:flex;"><span>+---------+   |                           |    +---------+
</span></span><span style="display:flex;"><span>| process |   |                           |    | process |
</span></span><span style="display:flex;"><span>| pid=43  |   |                           |    | pid=44  |
</span></span><span style="display:flex;"><span>| tgid=43 |   |                           |    | tgid=42 |
</span></span><span style="display:flex;"><span>+---------+   |                           |    +---------+
</span></span><span style="display:flex;"><span>&lt;-- PID 43 --&gt;|&lt;--------- PID 42 --------&gt;|&lt;--- PID 44 ---&gt;
</span></span><span style="display:flex;"><span>                        KERNEL VIEW
</span></span></code></pre></div><h2 id="posix-thread">POSIX Thread<a hidden class="anchor" aria-hidden="true" href="#posix-thread">#</a></h2>
<blockquote>
<p>与其说是 pthread 的历史，不如说是 kernel 变得更大更强，对线程模型支持得更好的历史。</p>
</blockquote>
<ul>
<li>LinuxThreads（早期）</li>
<li>NPTL(Native POSIX Thread Library)（现在）</li>
</ul>
<p>查看你的 pthread 实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ getconf GNU_LIBPTHREAD_VERSION
</span></span><span style="display:flex;"><span>NPTL 2.38
</span></span></code></pre></div><h3 id="linuxthreads">LinuxThreads<a hidden class="anchor" aria-hidden="true" href="#linuxthreads">#</a></h3>
<p>在 Linux 操作系统中， LinuxThreads 是 1996 年推出的 POSIX Threads 的部分实现，其主要开发者是 Xavier Leroy 。</p>
<h4 id="管理线程manager-thread">管理线程(Manager Thread)<a hidden class="anchor" aria-hidden="true" href="#管理线程manager-thread">#</a></h4>
<p>为什么需要管理线程？</p>
<ul>
<li>对致命的信号做出反应(fatal signals)，并杀死或终止整个线程。（后文详细说明这一点的原因，这是由 LinuxThreads 的缺陷导致的）</li>
<li>释放用作线程栈的内存不能由该线程本身执行，必须要等这个线程结束再进行，因此需要特殊的管理线程来收尾。</li>
<li>释放 tls 需要遍历所有线程，因此需要管理线程。</li>
<li>终止线程必须是等待的（由管理线程等待），不然会出现僵尸线程。</li>
<li>当主线程调用 <code>pthread_exit()</code> 时，这个进程不能就此结束。正确的行为是，主线程 sleep ，当其他线程被杀死后管理线程再唤醒主线程，主线程此时才能退出。</li>
</ul>
<h4 id="缺陷">缺陷<a hidden class="anchor" aria-hidden="true" href="#缺陷">#</a></h4>
<ul>
<li>管理线程带来的额外开销。</li>
<li>使用信号实现同步原语。</li>
<li>基本符合 POSIX 标准，信号处理除外。</li>
</ul>
<p>LinuxThreads 实现的线程，本质上是共享了内存、文件描述符的进程，它们有着不同的 pid ，它们并不作为进程的一个整体：</p>
<blockquote>
<p>这里的 pid 是抽象概念，当时的 Kernel 并没有 pid 和 tgid 的区别。</p>
</blockquote>
<ul>
<li>发送到线程 pid 的信号只能由该线程处理。只要没有线程阻塞该信号，该行为就符合标准：程序的一个（未指定）线程处理该信号。</li>
<li>但是，如果向 pid 发送信号的线程阻塞了信号，那么 LinuxThreads 将简单地在该线程中排队，仅当该线程解除阻塞信号时才执行处理程序，而不是立即在不阻塞信号的另一个线程中执行。</li>
</ul>
<p><strong>实现者的吐槽：This is to be viewed as a LinuxThreads bug, but I currently don&rsquo;t see any way to implement the POSIX behavior without kernel support.</strong></p>
<h4 id="线程模型">线程模型<a hidden class="anchor" aria-hidden="true" href="#线程模型">#</a></h4>
<p>此时就已经出现了 Linux 代表性的一对一(one-to-one)模型。内核对线程和进程不做区分，所谓的内核线程是 <code>task_struct</code> ，而内核调度时也只考虑它们。</p>
<h5 id="one-to-one-vs-many-to-one">one-to-one vs many-to-one<a hidden class="anchor" aria-hidden="true" href="#one-to-one-vs-many-to-one">#</a></h5>
<p>当用户创建出很多用户线程时， Linux 的做法是：每当用户调用库函数创建线程，库函数让内核创建出一个新的内核线程。</p>
<ul>
<li>多处理器上，CPU 密集型程序的开销最小，即每个处理器上都可以跑一个线程（思考一下如果是 many-to-one ，一个内核线程对应多个用户线程，则很难在多核上并行）。</li>
<li>I/O 操作开销最小（思考一下如果是 many-to-one ，阻塞 IO 操作实现起来有多么复杂）。</li>
<li>实现简单，不与内核过度耦合（内核调度可以完成大部分复杂工作）。</li>
</ul>
<h5 id="one-to-one-vs-many-to-many">one-to-one vs many-to-many<a hidden class="anchor" aria-hidden="true" href="#one-to-one-vs-many-to-many">#</a></h5>
<p>那么为什么不用多对多模型呢？</p>
<p>当时大多数商业 Unix 系统（Solaris、Digital Unix、IRIX）都以这种方式实现 POSIX 线程。该模型结合了“多对一”和“一对一”模型的优点，很有吸引力。</p>
<p>多对多模型能成功避免两种模型的最坏情况。在上下文切换成本高昂的内核 Digital Unix 上多对多模型几乎可以说是唯一选择。</p>
<p>但是，多对多模型的实现相当复杂，并且需要 Linux 增加支持很多新的功能。另一方面，Linus Torvalds 和其他 Linux 内核开发人员一直以整体简单性的名义推动一对一模型，更何况 Linux 的上下文切换效率相当出色。</p>
<blockquote>
<p>虽然多对多模型在 pthread 中被放弃，但是它在一些编程语言的运行时中大放异彩。</p>
</blockquote>
<h5 id="管理线程与一对一模型结合导致的问题">管理线程与一对一模型结合导致的问题<a hidden class="anchor" aria-hidden="true" href="#管理线程与一对一模型结合导致的问题">#</a></h5>
<ul>
<li>管理线程只能在一个核上运行，这导致加速比变低，性能变差。</li>
<li>由于整个系统围绕着管理线程设计，上下文切换开销变大。</li>
</ul>
<h3 id="nptl">NPTL<a hidden class="anchor" aria-hidden="true" href="#nptl">#</a></h3>
<p>为了解决 LinuxThreads 的一些问题，内核开发人员设计实现了 NPTL(Native POSIX Thread Library) 。</p>
<ul>
<li>NPTL 完全兼容 POSIX 标准。</li>
<li>NPTL 在多处理器机器上效果也很好。</li>
<li>NPTL 的启动开销不大。</li>
<li>NPTL 也能利用到 NUMA 架构的优势。</li>
<li>NPTL 和 LinuxThreads 二进制兼容（LD 实现的）。</li>
</ul>
<h4 id="利用了新的内核特性">利用了新的内核特性<a hidden class="anchor" aria-hidden="true" href="#利用了新的内核特性">#</a></h4>
<ul>
<li>NPTL 无需管理线程：
<ul>
<li>不需要转发 fatal signal 的工作，内核可以处理好向某一进程发送信号的工作。</li>
<li>不需要由管理线程析构，内核可以处理线程内存的释放。</li>
<li>不需要管理线程来避免僵尸线程，内核可以在清理父线程前等待所有线程。</li>
<li>去掉管理线程，对 SMP 和 NUMA 更友好。</li>
</ul>
</li>
<li>使用 <em>futex</em> 来实现同步，而且 futex 可以在进程间共享，能在更多场景使用。</li>
<li>NPTL 的每个线程都有自己的父线程，在进行资源统计时便于统计整个进程，此前的 LinuxThreads 不能做到。</li>
</ul>
<h4 id="如何实现-tls">如何实现 TLS<a hidden class="anchor" aria-hidden="true" href="#如何实现-tls">#</a></h4>
<p>我们都知道在写声明时加入 <code>__thread</code> 可以声明一个线程局部变量。那它是如何实现的呢？</p>
<p>在早期 LinuxThreads 的实现中， TLS 直接放在线程栈旁边。而在引入 NPTL 后，各个 libc （如 glibc, uClibc, musl）都是使用新增的 ELF 标准对 TLS 的支持和动态链接器来实现的。</p>
<p>查看一个 <code>__thread</code> 声明的汇编代码时，我们可能看到 <code>mov %fs:0xfffffffffffffffc,%eax</code> 。</p>
<p>这也就是 <code>mov %fs:-4,%eax</code> 。</p>
<p>这是什么？这太奇怪了！</p>
<p>虽然某些 CPU 架构有专用的寄存器来保存线程特定的上下文，但 x86 没有。众所周知，x86 只有少量的通用寄存器。</p>
<p>英特尔 80386 引入了 FS 和 GS 作为用户定义的段寄存器，但没有规定它们的用途。然而，随着多线程编程的兴起，人们看到了重新利用 FS 和 GS 的机会，并开始将它们用作线程寄存器。</p>
<p>TLS 的结构：</p>
<p><img alt="tls" loading="lazy" src="/image/tls.png"></p>
<ul>
<li>使用 <code>dlopen</code> 加载的 DSO(动态共享对象) 放在动态 TLS 中，其余的放在静态 TLS 中。</li>
<li>$dtv_t$ 可以看作是一个二维数组，可以通过模块 id 和偏移量对任何 TLS 变量进行寻址。TLS 变量偏移量是模块中的本地偏移量，模块 id 是进程中加载的 ELF 对象的索引号。</li>
</ul>
<p>访问一个 TLS 变量的通用方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>dtv[-<span style="color:#ff0;font-weight:bold">1</span>].counter; <span style="color:#007f7f">/* Pro tip: The length of this dtv array */</span>
</span></span><span style="display:flex;"><span>dtv[<span style="color:#ff0;font-weight:bold">0</span>].counter;  <span style="color:#007f7f">/* Generation counter for the DTV in this thread */</span>
</span></span><span style="display:flex;"><span>dtv[<span style="color:#ff0;font-weight:bold">1</span>].pointer;  <span style="color:#007f7f">/* Pointer to the main executable TLS block in this thread */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/* Pointer to a TLS variable defined in a module id `ti_module` */</span>
</span></span><span style="display:flex;"><span>main_tls_var = *(dtv[tls_index.ti_module].pointer + tls_index.ti_offset);
</span></span></code></pre></div><p>编译器和动态链接器共同计算出地址，因为可执行文件的 TLS 块和 TLS 偏移量都是提前知道的。</p>
<p>这种合作依赖于编译器在构建时的以下「事实」：</p>
<ul>
<li>FS 寄存器指向 TCB 。</li>
<li>编译器设置的 TLS 变量偏移量在运行时不会更改。</li>
<li>可执行文件的 TLS 块位于 TCB 之前。</li>
</ul>
<p>同时，将 TLS 放在 TCB 之前可以让经常被访问的内存更持久地留在缓存中。</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<ul>
<li><a href="https://www.lix.polytechnique.fr/~liberti/public/computing/parallel/threads/linuxthreads/linuxthreads-FAQ.html">LinuxThreads Frequently Asked Questions</a></li>
<li><a href="http://comet.lehman.cuny.edu/jung/cmp426697/NPTL.pdf">Linux threading models compared: LinuxThreads and NPTL</a></li>
<li><a href="https://www.cs.utexas.edu/~witchel/372/lectures/POSIX_Linux_Threading.pdf">NPTL design</a></li>
<li><a href="https://www.kernel.org/doc/ols/2006/ols2006v1-pages-409-420.pdf">uClibc NPTL design</a></li>
<li><a href="https://www.akkadia.org/drepper/tls.pdf">ELF Handling for Thread-Local Storage</a></li>
<li><a href="https://maskray.me/blog/2021-02-14-all-about-thread-local-storage">All about thread-local storage</a></li>
<li><a href="https://chao-tic.github.io/blog/2018/12/25/tls">A Deep dive into (implicit) Thread Local Storage</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://vaaandark.top/tags/linux/">Linux</a></li>
      <li><a href="https://vaaandark.top/tags/glibc/">Glibc</a></li>
      <li><a href="https://vaaandark.top/tags/hpc/">HPC</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://vaaandark.top/posts/relearning-cpu-1-branch-prediction/">
    <span class="title">« 上一页</span>
    <br>
    <span>恶补 CPU 知识之分支预测</span>
  </a>
  <a class="next" href="https://vaaandark.top/posts/rust-slower-than-python/">
    <span class="title">下一页 »</span>
    <br>
    <span>为什么 Rust std fs 慢于 Python</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on x"
            href="https://x.com/intent/tweet/?text=Pthread&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f&amp;hashtags=Linux%2cglibc%2cHPC">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f&amp;title=Pthread&amp;summary=Pthread&amp;source=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f&title=Pthread">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on whatsapp"
            href="https://api.whatsapp.com/send?text=Pthread%20-%20https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on telegram"
            href="https://telegram.me/share/url?text=Pthread&amp;url=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Pthread on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Pthread&u=https%3a%2f%2fvaaandark.top%2fposts%2fpthread%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><script src="https://giscus.app/client.js"
        data-repo="vaaandark/vaaandark.github.io"
        data-repo-id="R_kgDOGsxTxw"
        data-category="Announcements"
        data-category-id="DIC_kwDOGsxTx84CmAQ1"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://vaaandark.top/">vaaandark&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
